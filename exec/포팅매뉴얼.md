# 포팅 메뉴얼

## 1. 빌드 및 배포

### 버전

VS Code: 1.91.0

IntelliJ: IntelliJ IDEA Ultimate 2024.1.4

JDK: Oracle JDK 17.0.11

Node.js: 20.14.11

Nginx: nginx/1.18.0 (Ubuntu)

AWS EC2: Ubuntu 20.04.6 LTS

DB: MySQL 8.0.33

### 빌드 시 환경 변수

**FRONTEND**

docker build 시에 환경 변수 주입. 환경 변수는 다음과 같다.

VITE_REACT_APP_REST_API_KEY: 카카오 API 앱키

VITE_REACT_APP_REDIRECT_URL: 카카오 로그인 Redirect URL

VITE_REACT_APP_SERVER_URL: 서버 주소

VITE_REACT_APP_OPENVIDU_URL: Openvidu 서버 주소

```docker
docker build --no-cache -t moneyandlove-front:latest \
--build-arg VITE_REACT_APP_REST_API_KEY=5f5c8c06e4b41de351c85a775ab50b40 \
--build-arg VITE_REACT_APP_REDIRECT_URL=https://i11a405.q.ssafy.io/login/oauth2/callback \
--build-arg VITE_REACT_APP_SERVER_URL=https://i11a405.q.ssafy.io/api/ \
--build-arg VITE_REACT_APP_OPENVIDU_URL=https://i11a405.q.ssafy.io:8443/api/ .
```

docker run을 통해 컨테이너 실행, 3000:5173 포트 포워딩

```docker
docker run -d --name moneyandlove-front -p 3000:5173 moneyandlove-front:latest
```

**BACKEND**

docker build 시에 환경 변수 주입. 환경 변수는 다음과 같다.

PROFILE: 배포 환경 선택(application-prod.yml)

KAKAO_CLIENT: 카카오 API 앱키

KAKAO_SECRET: 카카오 시크릿키

AWS_ACEESSKEY: AWS S3 접속 키

AWS_BUCKET_NAME: AWS S3 저장 버킷 명

AWS_SECRETKEY: AWS 비밀키

```docker
cd Love-Money_BE/moneyandlove/
docker build -t moneyandlove-server:latest \
--build-arg PROFILE=prod \
--build-arg KAKAO_CLIENT=5f5c8c06e4b41de351c85a775ab50b40 \
--build-arg KAKAO_SECRET=c9mNWn31RQEmHSqyDvwNNnH5KWACwyy7 \
--build-arg AWS_ACCESSKEY=AKIAYS2NP6ADT6RVZ662 \
--build-arg AWS_BUCKET_NAME=moneyandlove-s3-bucket \
--build-arg AWS_SECRETKEY=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 .
```

docker run을 통해 컨테이너 실행

```docker
docker run -d --name moneyandlove-server -p 8080:8080 moneyandlove-server:latest
```

**OPENVIDU CALL SERVER(WebRTC 폴더)**

docker build를 통해 prod 환경변수 주입

PROFILE: 배포 환경 선택(application-prod.yml)

```docker
docker build -t moneyandlove-webrtc:latest --build-arg PROFILE=prod . 
```

### 배포 시 특이사항

- URL 접속 시: [i11a405.q.ssafy.io](http://i11a405.p.ssafy.io/)

**mongodb 컨테이너 실행**

```docker
docker run -d --name moneyandlove-mongo -p 27017:27017 \ 
-e MONGO_INITDB_DATABASE=moneyandlovedb mongo:latest
```

**MySQL 컨테이너 실행**

```docker
docker run -d --name moneyandlove-mysql \
-v /home/ubuntu/mysql-data/my.cnf:/etc/mysql/my.cnf \
-p 3306:3306 \
-e MYSQL_DATABASE=moneyandlovedb \
-e MYSQL_ROOT_PASSWORD=1234 \
-e TZ=Asia/Seoul \
mysql:8.0.33
```

MySQL의 경우 user: myteam password: ssafy로 User 생성 후 모든 권한을 부여해야 합니다.

**Redis 컨테이너 실행**

```docker
docker run -d --name redis-server -p 4379:6379 redis:latest
```

4379:6379로 포트포워딩을 해야합니다. 

**OPENVIDU를 온프레미스로 설치**

https://docs.openvidu.io/en/2.30.0/deployment/ce/on-premises/

```
curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_2.30.0.sh | bash
```

다음과 같이 파일 수정

```
/opt/openvidu/.env
nano .env

# Domain name. If you do not have one, the public IP of the machine.
# For example: 198.51.100.1, or openvidu.example.com
DOMAIN_OR_PUBLIC_IP=i11a405.q.ssafy.io

# OpenVidu SECRET used for apps to connect to OpenVidu server and users to access to OpenVidu Dashboard
OPENVIDU_SECRET=test

# Certificate type:
# - selfsigned:  Self signed certificate. Not recommended for production use.
#                Users will see an ERROR when connected to web page.
# - owncert:     Valid certificate purchased in a Internet services company.
#                Please put the certificates files inside folder ./owncert
#                with names certificate.key and certificate.cert
# - letsencrypt: Generate a new certificate using letsencrypt. Please set the
#                required contact email for Let's Encrypt in LETSENCRYPT_EMAIL
#                variable.
CERTIFICATE_TYPE=letsencrypt

# If CERTIFICATE_TYPE=letsencrypt, you need to configure a valid email for notifications
LETSENCRYPT_EMAIL=jjh981108@gmail.com

# redirected to https://DOMAIN_OR_PUBLIC_IP:HTTPS_PORT/.
# WARNING: the default port 80 cannot be changed during the first boot
# if you have chosen to deploy with the option CERTIFICATE_TYPE=letsencrypt
HTTP_PORT=8442

# Changes the port of all services exposed by OpenVidu.
# SDKs, REST clients and browsers will have to connect to this port
HTTPS_PORT=8443

```

**docker-compose.override.yml 수정**

moneyandlove-webrtc 이미지 빌드 후 진행

```
/openvidu/docker-compose.override.yml
app:
        image: moneyandlove-webrtc
        restart: on-failure
        network_mode: host
        environment:
            - SERVER_PORT=5442
            - OPENVIDU_URL=http://localhost:5443
            - OPENVIDU_SECRET=${OPENVIDU_SECRET}
        logging:
            options:
                max-size: "${DOCKER_LOGS_MAX_SIZE:-100M}"
```

**openvidu 실행**

```
./openvidu start
```

**Nginx 설정**

```
/etc/nginx/site-enable/default

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name i11a405.q.ssafy.io;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
}

server {
        root /var/www/html;

        index index.html index.htm index.nginx-debian.html;
    server_name i11a405.q.ssafy.io; # managed by Certbot

        location / {
                proxy_pass http://localhost:3000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api {
                proxy_pass http://localhost:8080;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/i11a405.q.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/i11a405.q.ssafy.io/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

server {
    if ($host = i11a405.q.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

        listen 80 ;
        listen [::]:80 ;
    server_name i11a405.q.ssafy.io;
    return 404; # managed by Certbot

}

```

### DB 프로퍼티

LOVE-Money_BE/moneyandlove/application-prod.yml에 정의

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: "jdbc:mysql://i11a405.p.ssafy.io:3306/moneyandlovedb"
    username: myteam
    password: ssafy
  jpa:
    hibernate:
      ddl-auto: update
    open-in-view: false
  data:
    mongodb:
      uri: "mongodb://i11a405.p.ssafy.io:27017/moneyandlovedb"
    redis:
      url: "redis://i11a405.p.ssafy.io:4379/0"
  logging.level:
    org.hibernate.SQL: debug

```

## 외부 서비스 정보

- Kakao 로그인 API
- AWS S3
